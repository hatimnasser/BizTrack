# ═══════════════════════════════════════════════════════════════
#  BizTrack Pro — GitHub Actions APK Builder
#
#  HOW TO USE:
#  1. Paste all project files into your GitHub repo (see README).
#  2. Go to  Actions → "Build BizTrack APK"  and click
#     "Run workflow" (or just push a commit to main).
#  3. When the green ✓ appears, click the run → scroll to
#     "Artifacts" → download  BizTrack-Pro-APK.zip
#  4. Unzip it — inside is  app-debug.apk.
#  5. Copy the APK to your Android phone and install it
#     (enable "Install from unknown sources" once).
#
#  Build time: ~8–12 minutes on first run (Gradle cache cold).
#              ~4–6 minutes on subsequent runs (cache warm).
# ═══════════════════════════════════════════════════════════════

name: Build BizTrack APK

# ── Triggers ────────────────────────────────────────────────────
on:
  push:
    branches: [ main, master ]   # auto-build on every push
  workflow_dispatch:             # manual "Run workflow" button

# ── Build job ───────────────────────────────────────────────────
jobs:
  build:
    name: Assemble Debug APK
    runs-on: ubuntu-latest       # GitHub's free Linux runner

    steps:

      # ── 1. Get source code ────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Java 17 (required by Android Gradle Plugin 8+) ────
      #    NO cache: gradle here — android/ doesn't exist at
      #    checkout time (it's generated by cap add android).
      #    Caching is handled manually in step 9 below.
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ── 3. Node.js 20 (Capacitor CLI requires ≥ 18) ──────────
      #    NO cache: npm here — there is no package-lock.json in
      #    the repo (we use npm install, not npm ci).
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ── 4. Install npm packages ───────────────────────────────
      - name: Install npm dependencies
        run: npm install

      # ── 5. Add the Android platform ───────────────────────────
      #    Generates the android/ folder from @capacitor/android.
      - name: Add Capacitor Android platform
        run: npx cap add android --no-telemetry

      # ── 6. Tell Gradle where the Android SDK lives ────────────
      #    GitHub's ubuntu-latest runner pre-installs the Android
      #    SDK at $ANDROID_HOME. Gradle reads it from this file.
      - name: Write android/local.properties
        run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

      # ── 7. Write android/gradle.properties ───────────────────
      #    FIX FOR EXIT CODE 249 (OOM kill):
      #    Gradle reads memory config from gradle.properties BEFORE
      #    it reads environment variables, so GRADLE_OPTS alone is
      #    not reliable on CI. We must write the file explicitly.
      #
      #    android/ is generated above so this file doesn't exist
      #    in the repo — we create it here every build.
      #
      #    -Xmx1536m  = 1.5 GB heap (safe on 7 GB GitHub runner;
      #                 leaves room for AAPT2, D8, the node process)
      #    -XX:+HeapDumpOnOutOfMemoryError  = better crash messages
      #    parallel=false + workers=1  = sequential tasks, lower peak RAM
      #    configureondemand=false      = evaluate all projects upfront
      #    caching=false                = no local build cache (CI)
      - name: Write android/gradle.properties
        run: |
          cat >> android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx1536m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.workers.max=1
          org.gradle.configureondemand=false
          org.gradle.caching=false
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

      # ── 8. Sync web assets + plugin native code into Android ──
      #    Copies www/ → android/app/src/main/assets/public/
      #    and links @capacitor-community/sqlite native code.
      - name: Capacitor sync
        run: npx cap sync android --no-telemetry

      # ── 9. Ensure Gradle wrapper is executable ────────────────
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # ── 10. Cache Gradle's downloaded dependencies ────────────
      #    Keyed on package.json — android/ files don't exist at
      #    checkout so we cannot use hashFiles('android/...').
      #    continue-on-error: a cache miss never breaks the build.
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ── 11. Build the debug APK ───────────────────────────────
      #    --no-daemon + gradle.properties daemon=false = certain
      #    no background JVM is left running on the runner.
      #    --stacktrace kept for useful error messages;
      #    --info removed (generates 100k+ lines, slows CI).
      - name: Build debug APK
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}

      # ── 12. Rename APK with version & date for clarity ────────
      - name: Rename APK
        run: |
          DATE=$(date +%Y%m%d)
          cp android/app/build/outputs/apk/debug/app-debug.apk \
             "BizTrack-Pro-v3.1-debug-${DATE}.apk"

      # ── 13. Upload APK as a downloadable artifact ─────────────
      #    Go to  Actions → (this run) → Artifacts  to download.
      #    The zip will contain the APK file inside.
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: BizTrack-Pro-APK
          path: "BizTrack-Pro-v3.1-debug-*.apk"
          retention-days: 30    # artifact kept for 30 days

      # ── 14. Print success summary ─────────────────────────────
      - name: Build summary
        if: success()
        run: |
          echo "## ✅ BizTrack Pro APK Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App ID | com.biztrack.pro |" >> $GITHUB_STEP_SUMMARY
          echo "| Build type | Debug |" >> $GITHUB_STEP_SUMMARY
          echo "| Built at | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⬇️ **Download**: Click the \`BizTrack-Pro-APK\` artifact below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          APK_SIZE=$(du -sh android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "APK size: **${APK_SIZE}**" >> $GITHUB_STEP_SUMMARY
