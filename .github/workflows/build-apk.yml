# ═══════════════════════════════════════════════════════════════
#  BizTrack Pro — GitHub Actions APK Builder
#
#  HOW TO USE:
#  1. Paste all project files into your GitHub repo (see README).
#  2. Go to  Actions → "Build BizTrack APK"  and click
#     "Run workflow" (or just push a commit to main).
#  3. When the green ✓ appears, click the run → scroll to
#     "Artifacts" → download  BizTrack-Pro-APK.zip
#  4. Unzip it — inside is  app-debug.apk.
#  5. Copy the APK to your Android phone and install it
#     (enable "Install from unknown sources" once).
#
#  Build time: ~10–15 minutes on first run (Gradle cache cold).
#              ~6–8 minutes on subsequent runs (cache warm).
# ═══════════════════════════════════════════════════════════════

name: Build BizTrack APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Assemble Debug APK
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Java 17 — no cache: gradle (android/ doesn't exist yet at checkout)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Node 20 — no cache: npm (no lock file in repo)
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Install npm packages
      - name: Install npm dependencies
        run: npm install

      # 5. Generate the android/ folder
      - name: Add Capacitor Android platform
        run: npx cap add android --no-telemetry

      # 6. Point Gradle at the pre-installed Android SDK
      - name: Write android/local.properties
        run: echo "sdk.dir=$ANDROID_HOME" > android/local.properties

      # 7. ── FIX FOR EXIT CODE 249 ─────────────────────────────
      #    Root cause: the previous heredoc had leading SPACES on
      #    every property line because of YAML indentation. Gradle
      #    silently ignores any property line that starts with
      #    whitespace, so the JVM launched with its default ~256m
      #    heap and was immediately OOM-killed (exit 249).
      #
      #    Fix: Python writes the file. Python strips indentation
      #    correctly (textwrap.dedent) and is immune to shell
      #    quoting/indentation issues entirely.
      #
      #    -Xmx1g = 1 GB heap. Conservative on purpose — AAPT2,
      #    D8, and R8 each spin up their own JVM child processes
      #    alongside Gradle. 1g + children fits in the 7g runner.
      - name: Write android/gradle.properties
        run: |
          python3 -c "
          import pathlib, textwrap
          props = textwrap.dedent('''
              org.gradle.jvmargs=-Xmx1g -XX:MaxMetaspaceSize=256m -Dfile.encoding=UTF-8
              org.gradle.daemon=false
              org.gradle.parallel=false
              org.gradle.workers.max=1
              org.gradle.configureondemand=false
              org.gradle.caching=false
              android.useAndroidX=true
              android.enableJetifier=true
          ''').strip()
          p = pathlib.Path('android/gradle.properties')
          original = p.read_text() if p.exists() else ''
          cleaned = '\n'.join(l for l in original.splitlines() if not l.strip().startswith('org.gradle.jvmargs'))
          p.write_text(cleaned.rstrip() + '\n' + props + '\n')
          print(p.read_text())
          "

      # 8. Sync www/ assets and SQLite plugin into android/
      - name: Capacitor sync
        run: npx cap sync android --no-telemetry

      # 9. Ensure Gradle wrapper is executable
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # 10. Cache ~/.gradle — keyed on package.json (android/ files
      #     don't exist at checkout; hashFiles('android/...') errors)
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # 11. Build the APK
      - name: Build debug APK
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}

      # 12. Rename with date stamp
      - name: Rename APK
        run: |
          DATE=$(date +%Y%m%d)
          cp android/app/build/outputs/apk/debug/app-debug.apk \
             "BizTrack-Pro-v3.1-debug-${DATE}.apk"

      # 13. Upload as downloadable artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: BizTrack-Pro-APK
          path: "BizTrack-Pro-v3.1-debug-*.apk"
          retention-days: 30

      # 14. Summary
      - name: Build summary
        if: success()
        run: |
          echo "## BizTrack Pro APK Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App ID | com.biztrack.pro |" >> $GITHUB_STEP_SUMMARY
          echo "| Build type | Debug |" >> $GITHUB_STEP_SUMMARY
          echo "| Built at | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          APK_SIZE=$(du -sh android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "| APK size | ${APK_SIZE} |" >> $GITHUB_STEP_SUMMARY
